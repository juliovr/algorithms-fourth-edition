package cl.julio.algorithmsFourthEdition.chapter2.section2;

import static cl.julio.algorithmsFourthEdition.Common.less;

import cl.julio.algorithmsFourthEdition.Common;
import cl.julio.algorithmsFourthEdition.chapter2.section1.Insertion;

/**
 * 
Start
Time elapsed array 50000 elements: 13601 ms
Time elapsed array 50000 elements: 11707 ms
Time elapsed array 50000 elements: 6335 ms
Time elapsed array 50000 elements: 11628 ms
Time elapsed array 50000 elements: 11447 ms
Time elapsed array 50000 elements: 6292 ms
Time elapsed array 50000 elements: 11858 ms
Time elapsed array 50000 elements: 11624 ms
Time elapsed array 50000 elements: 11685 ms
Time elapsed array 50000 elements: 11413 ms
=========== Report ===========
CUTOFF:     1000
Total time: 107590
Min time:   6292
Max time:   13601
Avg time:   10759
==============================
Time elapsed array 50000 elements: 11436 ms
Time elapsed array 50000 elements: 11351 ms
Time elapsed array 50000 elements: 10017 ms
Time elapsed array 50000 elements: 11384 ms
Time elapsed array 50000 elements: 11425 ms
Time elapsed array 50000 elements: 9017 ms
Time elapsed array 50000 elements: 11345 ms
Time elapsed array 50000 elements: 11354 ms
Time elapsed array 50000 elements: 8427 ms
Time elapsed array 50000 elements: 11452 ms
=========== Report ===========
CUTOFF:     2000
Total time: 107208
Min time:   8427
Max time:   11452
Avg time:   10720
==============================
Time elapsed array 50000 elements: 11493 ms
Time elapsed array 50000 elements: 8653 ms
Time elapsed array 50000 elements: 11316 ms
Time elapsed array 50000 elements: 11651 ms
Time elapsed array 50000 elements: 9150 ms
Time elapsed array 50000 elements: 11426 ms
Time elapsed array 50000 elements: 11318 ms
Time elapsed array 50000 elements: 10135 ms
Time elapsed array 50000 elements: 11638 ms
Time elapsed array 50000 elements: 6240 ms
=========== Report ===========
CUTOFF:     3000
Total time: 103020
Min time:   6240
Max time:   11651
Avg time:   10302
==============================
Time elapsed array 50000 elements: 11585 ms
Time elapsed array 50000 elements: 11335 ms
Time elapsed array 50000 elements: 6637 ms
Time elapsed array 50000 elements: 12702 ms
Time elapsed array 50000 elements: 11577 ms
Time elapsed array 50000 elements: 7440 ms
Time elapsed array 50000 elements: 12306 ms
Time elapsed array 50000 elements: 15223 ms
Time elapsed array 50000 elements: 11715 ms
Time elapsed array 50000 elements: 14546 ms
=========== Report ===========
CUTOFF:     4000
Total time: 115066
Min time:   6637
Max time:   15223
Avg time:   11506
==============================
Time elapsed array 50000 elements: 7075 ms
Time elapsed array 50000 elements: 13935 ms
Time elapsed array 50000 elements: 13584 ms
Time elapsed array 50000 elements: 7811 ms
Time elapsed array 50000 elements: 13221 ms
Time elapsed array 50000 elements: 8603 ms
Time elapsed array 50000 elements: 16395 ms
Time elapsed array 50000 elements: 18587 ms
Time elapsed array 50000 elements: 10339 ms
Time elapsed array 50000 elements: 17142 ms
=========== Report ===========
CUTOFF:     5000
Total time: 126692
Min time:   7075
Max time:   18587
Avg time:   12669
==============================
Time elapsed array 50000 elements: 8010 ms
Time elapsed array 50000 elements: 16950 ms
Time elapsed array 50000 elements: 16832 ms
Time elapsed array 50000 elements: 12926 ms
Time elapsed array 50000 elements: 17342 ms
Time elapsed array 50000 elements: 9379 ms
Time elapsed array 50000 elements: 17072 ms
Time elapsed array 50000 elements: 8227 ms
Time elapsed array 50000 elements: 17079 ms
Time elapsed array 50000 elements: 16948 ms
=========== Report ===========
CUTOFF:     6000
Total time: 140765
Min time:   8010
Max time:   17342
Avg time:   14076
==============================
Time elapsed array 50000 elements: 13695 ms
Time elapsed array 50000 elements: 17391 ms
Time elapsed array 50000 elements: 10540 ms
Time elapsed array 50000 elements: 16980 ms
Time elapsed array 50000 elements: 8529 ms
Time elapsed array 50000 elements: 16812 ms
Time elapsed array 50000 elements: 7949 ms
Time elapsed array 50000 elements: 17467 ms
Time elapsed array 50000 elements: 17775 ms
Time elapsed array 50000 elements: 15321 ms
=========== Report ===========
CUTOFF:     7000
Total time: 142459
Min time:   7949
Max time:   17775
Avg time:   14245
==============================
Time elapsed array 50000 elements: 17207 ms
Time elapsed array 50000 elements: 13551 ms
Time elapsed array 50000 elements: 17267 ms
Time elapsed array 50000 elements: 12371 ms
Time elapsed array 50000 elements: 17338 ms
Time elapsed array 50000 elements: 10582 ms
Time elapsed array 50000 elements: 17983 ms
Time elapsed array 50000 elements: 12044 ms
Time elapsed array 50000 elements: 12203 ms
Time elapsed array 50000 elements: 6850 ms
=========== Report ===========
CUTOFF:     8000
Total time: 137396
Min time:   6850
Max time:   17983
Avg time:   13739
==============================
Time elapsed array 50000 elements: 11411 ms
Time elapsed array 50000 elements: 6746 ms
Time elapsed array 50000 elements: 11471 ms
Time elapsed array 50000 elements: 6651 ms
Time elapsed array 50000 elements: 11331 ms
Time elapsed array 50000 elements: 6795 ms
Time elapsed array 50000 elements: 11319 ms
Time elapsed array 50000 elements: 6823 ms
Time elapsed array 50000 elements: 12581 ms
Time elapsed array 50000 elements: 7782 ms
=========== Report ===========
CUTOFF:     9000
Total time: 92910
Min time:   6651
Max time:   12581
Avg time:   9291
==============================
Time elapsed array 50000 elements: 11752 ms
Time elapsed array 50000 elements: 7824 ms
Time elapsed array 50000 elements: 11331 ms
Time elapsed array 50000 elements: 8675 ms
Time elapsed array 50000 elements: 11386 ms
Time elapsed array 50000 elements: 9761 ms
Time elapsed array 50000 elements: 11197 ms
Time elapsed array 50000 elements: 11597 ms
Time elapsed array 50000 elements: 6321 ms
Time elapsed array 50000 elements: 11407 ms
=========== Report ===========
CUTOFF:     10000
Total time: 101251
Min time:   6321
Max time:   11752
Avg time:   10125
==============================
Time elapsed array 50000 elements: 7079 ms
Time elapsed array 50000 elements: 13224 ms
Time elapsed array 50000 elements: 9035 ms
Time elapsed array 50000 elements: 11323 ms
Time elapsed array 50000 elements: 10298 ms
Time elapsed array 50000 elements: 6160 ms
Time elapsed array 50000 elements: 11314 ms
Time elapsed array 50000 elements: 7321 ms
Time elapsed array 50000 elements: 12328 ms
Time elapsed array 50000 elements: 10245 ms
=========== Report ===========
CUTOFF:     11000
Total time: 98327
Min time:   6160
Max time:   13224
Avg time:   9832
==============================
Time elapsed array 50000 elements: 6454 ms
Time elapsed array 50000 elements: 12278 ms
Time elapsed array 50000 elements: 8037 ms
Time elapsed array 50000 elements: 13163 ms
Time elapsed array 50000 elements: 11156 ms
Time elapsed array 50000 elements: 7045 ms
Time elapsed array 50000 elements: 12297 ms
Time elapsed array 50000 elements: 10382 ms
Time elapsed array 50000 elements: 7710 ms
Time elapsed array 50000 elements: 13157 ms
=========== Report ===========
CUTOFF:     12000
Total time: 101679
Min time:   6454
Max time:   13163
Avg time:   10167
==============================
Time elapsed array 50000 elements: 10890 ms
Time elapsed array 50000 elements: 6740 ms
Time elapsed array 50000 elements: 11722 ms
Time elapsed array 50000 elements: 13688 ms
Time elapsed array 50000 elements: 7045 ms
Time elapsed array 50000 elements: 11524 ms
Time elapsed array 50000 elements: 10668 ms
Time elapsed array 50000 elements: 7722 ms
Time elapsed array 50000 elements: 13390 ms
Time elapsed array 50000 elements: 11262 ms
=========== Report ===========
CUTOFF:     13000
Total time: 104651
Min time:   6740
Max time:   13688
Avg time:   10465
==============================
Time elapsed array 50000 elements: 7312 ms
Time elapsed array 50000 elements: 12240 ms
Time elapsed array 50000 elements: 11630 ms
Time elapsed array 50000 elements: 7074 ms
Time elapsed array 50000 elements: 12766 ms
Time elapsed array 50000 elements: 11064 ms
Time elapsed array 50000 elements: 7060 ms
Time elapsed array 50000 elements: 11292 ms
Time elapsed array 50000 elements: 10905 ms
Time elapsed array 50000 elements: 7404 ms
=========== Report ===========
CUTOFF:     14000
Total time: 98747
Min time:   7060
Max time:   12766
Avg time:   9874
==============================
Time elapsed array 50000 elements: 12448 ms
Time elapsed array 50000 elements: 12131 ms
Time elapsed array 50000 elements: 7633 ms
Time elapsed array 50000 elements: 12002 ms
Time elapsed array 50000 elements: 11581 ms
Time elapsed array 50000 elements: 7322 ms
Time elapsed array 50000 elements: 11463 ms
Time elapsed array 50000 elements: 11353 ms
Time elapsed array 50000 elements: 7408 ms
Time elapsed array 50000 elements: 6324 ms
=========== Report ===========
CUTOFF:     15000
Total time: 99665
Min time:   6324
Max time:   12448
Avg time:   9966
==============================
Time elapsed array 50000 elements: 11760 ms
Time elapsed array 50000 elements: 8151 ms
Time elapsed array 50000 elements: 6287 ms
Time elapsed array 50000 elements: 11423 ms
Time elapsed array 50000 elements: 7809 ms
Time elapsed array 50000 elements: 6410 ms
Time elapsed array 50000 elements: 13131 ms
Time elapsed array 50000 elements: 9733 ms
Time elapsed array 50000 elements: 6595 ms
Time elapsed array 50000 elements: 13413 ms
=========== Report ===========
CUTOFF:     16000
Total time: 94712
Min time:   6287
Max time:   13413
Avg time:   9471
==============================
Time elapsed array 50000 elements: 9543 ms
Time elapsed array 50000 elements: 6770 ms
Time elapsed array 50000 elements: 12253 ms
Time elapsed array 50000 elements: 10650 ms
Time elapsed array 50000 elements: 6592 ms
Time elapsed array 50000 elements: 11514 ms
Time elapsed array 50000 elements: 11434 ms
Time elapsed array 50000 elements: 6960 ms
Time elapsed array 50000 elements: 11308 ms
Time elapsed array 50000 elements: 10193 ms
=========== Report ===========
CUTOFF:     17000
Total time: 97217
Min time:   6592
Max time:   12253
Avg time:   9721
==============================
Time elapsed array 50000 elements: 6846 ms
Time elapsed array 50000 elements: 11198 ms
Time elapsed array 50000 elements: 11859 ms
Time elapsed array 50000 elements: 7381 ms
Time elapsed array 50000 elements: 6397 ms
Time elapsed array 50000 elements: 12509 ms
Time elapsed array 50000 elements: 7885 ms
Time elapsed array 50000 elements: 6130 ms
Time elapsed array 50000 elements: 11958 ms
Time elapsed array 50000 elements: 8258 ms
=========== Report ===========
CUTOFF:     18000
Total time: 90421
Min time:   6130
Max time:   12509
Avg time:   9042
==============================
Time elapsed array 50000 elements: 6124 ms
Time elapsed array 50000 elements: 11502 ms
Time elapsed array 50000 elements: 8699 ms
Time elapsed array 50000 elements: 6191 ms
Time elapsed array 50000 elements: 11940 ms
Time elapsed array 50000 elements: 9847 ms
Time elapsed array 50000 elements: 6433 ms
Time elapsed array 50000 elements: 12040 ms
Time elapsed array 50000 elements: 9728 ms
Time elapsed array 50000 elements: 6528 ms
=========== Report ===========
CUTOFF:     19000
Total time: 89032
Min time:   6124
Max time:   12040
Avg time:   8903
==============================
Time elapsed array 50000 elements: 12442 ms
Time elapsed array 50000 elements: 10909 ms
Time elapsed array 50000 elements: 7095 ms
Time elapsed array 50000 elements: 12782 ms
Time elapsed array 50000 elements: 11244 ms
Time elapsed array 50000 elements: 7774 ms
Time elapsed array 50000 elements: 6659 ms
Time elapsed array 50000 elements: 12924 ms
Time elapsed array 50000 elements: 8283 ms
Time elapsed array 50000 elements: 6511 ms
=========== Report ===========
CUTOFF:     20000
Total time: 96623
Min time:   6511
Max time:   12924
Avg time:   9662
==============================
Time elapsed array 50000 elements: 11471 ms
Time elapsed array 50000 elements: 9000 ms
Time elapsed array 50000 elements: 6395 ms
Time elapsed array 50000 elements: 11557 ms
Time elapsed array 50000 elements: 9446 ms
Time elapsed array 50000 elements: 6663 ms
Time elapsed array 50000 elements: 11198 ms
Time elapsed array 50000 elements: 10958 ms
Time elapsed array 50000 elements: 7389 ms
Time elapsed array 50000 elements: 6101 ms
=========== Report ===========
CUTOFF:     21000
Total time: 90178
Min time:   6101
Max time:   11557
Avg time:   9017
==============================
Time elapsed array 50000 elements: 11524 ms
Time elapsed array 50000 elements: 7845 ms
Time elapsed array 50000 elements: 6122 ms
Time elapsed array 50000 elements: 12515 ms
Time elapsed array 50000 elements: 9941 ms
Time elapsed array 50000 elements: 6653 ms
Time elapsed array 50000 elements: 11936 ms
Time elapsed array 50000 elements: 10287 ms
Time elapsed array 50000 elements: 7100 ms
Time elapsed array 50000 elements: 11687 ms
=========== Report ===========
CUTOFF:     22000
Total time: 95610
Min time:   6122
Max time:   12515
Avg time:   9561
==============================
Time elapsed array 50000 elements: 11248 ms
Time elapsed array 50000 elements: 7781 ms
Time elapsed array 50000 elements: 6270 ms
Time elapsed array 50000 elements: 12734 ms
Time elapsed array 50000 elements: 8017 ms
Time elapsed array 50000 elements: 6175 ms
Time elapsed array 50000 elements: 11838 ms
Time elapsed array 50000 elements: 9578 ms
Time elapsed array 50000 elements: 7204 ms
Time elapsed array 50000 elements: 12102 ms
=========== Report ===========
CUTOFF:     23000
Total time: 92947
Min time:   6175
Max time:   12734
Avg time:   9294
==============================
Time elapsed array 50000 elements: 10620 ms
Time elapsed array 50000 elements: 7419 ms
Time elapsed array 50000 elements: 6103 ms
Time elapsed array 50000 elements: 11427 ms
Time elapsed array 50000 elements: 8642 ms
Time elapsed array 50000 elements: 6283 ms
Time elapsed array 50000 elements: 11278 ms
Time elapsed array 50000 elements: 10061 ms
Time elapsed array 50000 elements: 6854 ms
Time elapsed array 50000 elements: 12135 ms
=========== Report ===========
CUTOFF:     24000
Total time: 90822
Min time:   6103
Max time:   12135
Avg time:   9082
==============================
Done

 * 
 * @author julio
 *
 */
public class Exercise23_Improvements {

    public static void main(String[] args) throws Exception {
        System.out.println("Start");

        runExperiments(10);

        System.out.println("Done");
    }
    
    @SuppressWarnings({ "rawtypes" })
    private static void runExperiments(int numberExperiments) {
        for (int cutoff = 1000; cutoff < 25000; cutoff += 1000) {
            MergeSortWithImprovements mergeSort = new MergeSortWithImprovements(cutoff);
            
            long min = Long.MAX_VALUE;
            long max = 0;
            long sum = 0;
            
            for (int i = 0; i < numberExperiments; i++) {
                Comparable[] data = Common.loadDataFromFile("test_data/50000_numbers");
                int n = data.length;

                long start = System.currentTimeMillis();
                mergeSort.sort(data);
                long end = System.currentTimeMillis();

                long timeElapsed = end - start;
                System.out.println("Time elapsed array " + n + " elements: " + timeElapsed + " ms");

                if (!Common.isSorted(data)) {
                    System.err.println("Data is not sorted!!");
                }
                
                if (timeElapsed < min)
                    min = timeElapsed;
                
                if (timeElapsed > max)
                    max = timeElapsed;
                
                sum += timeElapsed;
            }
            
            long avg = sum / numberExperiments;

            System.out.println("=========== Report ===========");
            System.out.printf("CUTOFF:     %d\n", cutoff);
            System.out.printf("Total time: %d\n", sum);
            System.out.printf("Min time:   %d\n", min);
            System.out.printf("Max time:   %d\n", max);
            System.out.printf("Avg time:   %d\n", avg);
            System.out.println("==============================");
        }
        
    }
    
    private static class MergeSortWithImprovements {
        
        private final int cutoff;
        
        public MergeSortWithImprovements(int cutoff) {
            this.cutoff = cutoff;
        }
        
        @SuppressWarnings({ "rawtypes" })
        public void sort(Comparable[] array) {
            Comparable[] aux = new Comparable[array.length];

            // Improvement 3: Eliminate the copy to the auxiliary array. Just make the copy
            // once.
            for (int i = 0; i < array.length; i++) {
                aux[i] = array[i];
            }

            sort(array, aux, 0, array.length - 1);
        }

        @SuppressWarnings({ "rawtypes" })
        private void sort(Comparable[] array, Comparable[] aux, int low, int high) {
            // Improvement 1: Use insertion sort for small subarrays.
            if ((high - low) <= cutoff) {
                Insertion.sort(array);
                return;
            }

            int middle = low + (high - low) / 2;

            sort(array, aux, low, middle);
            sort(array, aux, middle + 1, high);

            // Improvement 2: Test whether the array is already in order.
            if (!Common.isSorted(array)) {
                merge(array, aux, low, middle, high);
            }
        }

        @SuppressWarnings({ "rawtypes" })
        private void merge(Comparable[] a, Comparable[] aux, int lo, int mid, int hi) {
            int left = lo;
            int right = hi;
            for (int i = lo; i <= hi; i++) {
                if (less(aux[left], aux[right])) {
                    a[i] = aux[left++];
                } else {
                    a[i] = aux[right--];
                }
            }
        }
        
    }

}
